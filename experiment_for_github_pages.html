<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Start experiment</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
    }
    canvas {
      border: 2px solid #333;
      margin-top: 20px;
      cursor: crosshair;
    }
    #consent-container {
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 30px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    #consent-container h2 {
      text-align: center;
    }
    #consent-container label {
      display: block;
      margin-top: 10px;
    }
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 3000px;
      margin: 20px auto;
    }
    .button-group button {
      width: 1000px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }
    #confirm-btn {
      background-color: #4CAF50;
      color: white;
    }
    #decline-btn {
      background-color: #ff4444;
      color: white;
    }
    #loading, #msg, #end-screen, #uploading, #upload-error {
      max-width: 4000px;
      margin: 0 auto;
    }
    #loading {
      font-size: 20px;
      color: #555;
      margin-top: 40px;
    }
    #msg {
      font-size: 20px;
      color: #333;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #end-screen {
      color: green;
      font-size: 30px;
      margin-top: 30px;
    }
    #tutorial {
      display: none;
      max-width: 4000px;
      margin: 0 auto;
    }
    .tutorial-page {
      display: none;
    }
    .tutorial-page.active {
      display: block;
    }
    .tutorial-image_extra {
      width: 960px;
      border: 2px solid #333;
      margin: 0 auto;
      display: block;
    }
    .tutorial-image {
      width: 960px;
      border: 0px solid #ddd;
      margin: 0 auto;
      display: block;
    }
    .tutorial-text {
      font-size: 20px;
      margin-bottom: 30px;
    }
    #tutorial-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .nav-button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dot {
      height: 15px;
      width: 15px;
      margin: 0 2px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.6s ease;
    }
    .dot.active {
      background-color: #4CAF50;
    }
    #uploading {
      font-size: 24px;
      color: #333;
      margin-top: 30px;
      display: none;
    }
    #upload-error {
      font-size: 20px;
      color: red;
      margin-top: 20px;
      display: none;
    }
    #retry-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="consent-container">
    <h1>PARTICIPANT INFORMATION SHEET</h1>
  
    <p><strong>Study Title:</strong><br>
    Detecting Image Changes in Everyday Scenes</p>
  
    <p><strong>Investigator:</strong><br>
    Yuqing Xu & Dr Miaolei Jia</p>
  
    <p>This study aims to examine how individuals detect visual changes in realistic scenes, such as shopfronts or product displays. The study aims to explore how different visual elements influence attention and the speed at which changes are noticed.</p>
  
    <p>After providing your consent, you will be asked to complete a brief online task. You will view pairs of alternating images that depict everyday commercial environments. In each pair, a small change will occur, and you will be asked to click on the location where you observe the difference. The task consists of approximately 10 to 20 trials and takes around 1 to 4 minutes to complete in total.</p>
  
    <p>Your participation is completely voluntary. You can withdraw at any time, and for any reason, simply by closing your browser. However, we can only pay you if you complete the study.</p>
  
    <p>No identifiable data will be collected from you as part of this study. This means that once your responses have been submitted to the research team, it will not be possible to withdraw this data as your individual responses cannot be identified.</p>
  
    <p>Data will be securely stored on University of Warwick computers and will be processed only for the purpose of scientific analysis. Access to the data will be restricted to Yuqing Xu and Dr Miaolei Jia. Summaries may be presented at conferences and included in scientific publications. Data will be reviewed after a period of 10 years, in line with the University of Warwick data retention policy.</p>
  
    <p>Please refer to the University of Warwick Research Privacy Notice which is available here: 
      <a href="https://warwick.ac.uk/services/idc/dataprotection/privacynotices/researchprivacynotice" target="_blank">
        University of Warwick Research Privacy Notice
      </a>
      or by contacting the Legal and Compliance Team at GDPR@warwick.ac.uk.</p>
  
    <p>This study has been reviewed and given favourable opinion by the University of Warwickâ€™s Humanities and Social Science Research Ethics Committee (HSSREC).</p>
  
    <p>If you require further information, please contact Yuqing Xu via <a href="mailto:Yuqing.Xu.1@wbs.ac.uk">Yuqing.Xu.1@wbs.ac.uk</a>.</p>
  
    <p><strong>Who should I contact if I wish to make a complaint?</strong><br>
      Any complaint should be addressed to the person below, who is a senior University of Warwick official entirely independent of this study:</p>
    <p>
      Head of Research Governance<br>
      Research & Impact Services<br>
      University House<br>
      University of Warwick<br>
      Coventry<br>
      CV4 8UW<br>
      Email: <a href="mailto:researchgovernance@warwick.ac.uk">researchgovernance@warwick.ac.uk</a><br>
      Tel: 024 765 75733
    </p>
  
    <p>If you wish to raise a complaint on how we have handled your personal data, you can contact our Data Protection Officer, Information and Data Director who will investigate the matter: <a href="mailto:DPO@warwick.ac.uk">DPO@warwick.ac.uk</a>.</p>
  
    <p>If you are not satisfied with our response or believe we are processing your personal data in a way that is not lawful you can complain to the Information Commissionerâ€™s Office (ICO).</p>
  
    <p><strong>Thank you for taking the time to read this Participant Information Leaflet.</strong></p>
    <div class="button-group">
      <!-- Consent button -->
      <button id="confirm-btn">I have read the above and consent to take part in this study.</button>
      <!-- Decline button -->
      <button id="decline-btn">I do not wish to participate.</button>
    </div>
    <p class="warning">If you click this button, the study will exit and you will not be able to participate.</p>
  
  </div>
  
  <div id="main-content" style="display: none;">
    <h1>Can you spot the change? Click it!</h1>
    <p id="status-msg" style="font-size:28px;">Please wait for the resources to be loaded</p>
    <div id="loading">ğŸ”„ Loading: <span id="progress">0%</span></div>
  
    <!-- æ–°å¢ç¤ºä¾‹å¼•å¯¼å®¹å™¨ -->
    <div id="tutorial">
      <!-- ç¤ºä¾‹é¡µé¢1 -->
      <div class="tutorial-page active" id="page-1">
        <img class="tutorial-image_extra" src="Calibration.jpeg" alt="å®éªŒæµç¨‹ä»‹ç»">
        <div class="tutorial-text">Welcome! Before we begin the main task, weâ€™d like to provide a brief example to help you understand what to expect.<br>Please follow the on-screen instructions at your own pace.</div>
      </div>
      
      <!-- ç¤ºä¾‹é¡µé¢2 -->
      <div class="tutorial-page" id="page-2">
        <img class="tutorial-image" src="example/example_1.jpg" alt="å®éªŒæµç¨‹">
        <div class="tutorial-text">This is the first image in the example pair. Something in the image will change.<br>Please pay attention to the details. Click Next to continue.</div>
      </div>
      
      <!-- ç¤ºä¾‹é¡µé¢3 -->
      <div class="tutorial-page" id="page-3">
        <img class="tutorial-image" src="example/example_2.jpg" alt="ç¤ºä¾‹1">
        <div class="tutorial-text">This is the second image in the example pair. Something in the image has changed.<br>Try to spot the change compared to the previous image. Click Next to continue.</div>
      </div>
      
      <!-- ç¤ºä¾‹é¡µé¢4 -->
      <div class="tutorial-page" id="page-4">
        <img class="tutorial-image" src="example/example_3.jpg" alt="ç¤ºä¾‹2">
        <div class="tutorial-text">The highlighted area below shows where the change occurred.<br>In the main task, you will be asked to click on the changed area in the second image of each pair. Click Next to continue.</div>
      </div>
      
      <!-- ç¤ºä¾‹é¡µé¢5 -->
      <div class="tutorial-page" id="page-5">
        <img class="tutorial-image" src="Slide1.jpeg" alt="ç¤ºä¾‹3">
        <div class="tutorial-text">In the task, two images alternate until you click. Please respond quickly.<br>If no click is made after 30 alternations, that trial wonâ€™t be recorded. Start when you are ready.</div>
      </div>
      
      <!-- å¯¼èˆªæŒ‰é’® -->
      <div id="tutorial-nav">
        <button class="nav-button" id="prev-btn" disabled>Previous</button>
        <div id="dots"></div>
        <button class="nav-button" id="next-btn">Next</button>
      </div>
    </div>
    
    <div id="experiment" style="display:none;">
      <canvas id="canvas" width="600"></canvas>
      <p id="msg">Preparing ...</p>
    </div>
  
    <div id="end-screen" style="display:none;">
      âœ… Experiment completed. Thanks for your participation! Redirecting to Prolific...
    </div>
    <div id="uploading">âŒ› Waiting for data upload...</div>
    <div id="upload-error">
      âŒ Data upload failed. Please check your internet connection and try again.
      <button id="retry-btn">Retry Upload</button>
    </div>
  </div>
  <script>
    // è·å–å…è´£å£°æ˜å®¹å™¨
    const consentContainer = document.getElementById("consent-container");
    
    const confirmBtn = document.getElementById("confirm-btn");
    const declineBtn = document.getElementById("decline-btn");
    const mainContent = document.getElementById("main-content");
    let timeoutHandle = setTimeout(() => {
      if (!confirmClicked && !declineClicked) {
        window.location.href = "about:blank";
      }
    }, 5 * 60 * 1000); // 5åˆ†é’Ÿå€’è®¡æ—¶

    let confirmClicked = false;
    let declineClicked = false;

    // æ–°å¢å…¨å±€å˜é‡ï¼šè®°å½•æ‰€æœ‰å¤±è´¥çš„ä¸Šä¼ è¯·æ±‚
    const failedPayloads = [];
    const MAX_RETRIES = 3; // æœ€å¤§é‡è¯•æ¬¡æ•°
    
    // åŒæ„æŒ‰é’®é€»è¾‘
    confirmBtn.addEventListener("click", () => {
      confirmClicked = true;
      clearTimeout(timeoutHandle);
      
      if (consentContainer) {
        consentContainer.style.display = "none";
      } else {
        console.error("Error: consentContainer not found");
      }
      
      mainContent.style.display = "block";
      preloadImages();
    });

    // æ‹’ç»æŒ‰é’®é€»è¾‘
    declineBtn.addEventListener("click", () => {
      if (!declineClicked) {
        declineClicked = true;
        clearTimeout(timeoutHandle);
        if (confirm("Are you sure you want to decline participation? This will close the experiment.")) {
          if (consentContainer) {
            consentContainer.style.display = "none";
          }
          window.location.href = "about:blank";
        }
      }
    });

    // è·å– URL å‚æ•°
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search.slice(1);
      const pairs = queryString.split("&");
      for (const pair of pairs) {
        const [key, value] = pair.split("=");
        if (key) {
          params[decodeURIComponent(key)] = decodeURIComponent(value || "");
        }
      }
      return params;
    }
    
    // è·å–æ‰€æœ‰ URL å‚æ•°
    const queryParams = getQueryParams();
    const referrer = document.referrer || "direct";
    
    // è®°å½•æ‰€æœ‰æŸ¥è¯¢å‚æ•°
    const participantInfo = {
      referrer: referrer,
      queryParams: JSON.stringify(queryParams)
    };
    
    console.log(participantInfo);
    
    const userId = "user_" + Math.random().toString(36).substr(2, 8);
    let imagePairs = [];
    let allPreloadedImages = [];
    let imagesReady = false;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const msg = document.getElementById('msg');
    const endScreen = document.getElementById('end-screen');
    const loadingEl = document.getElementById('loading');
    const statusEl = document.getElementById('status-msg');
    const progressEl = document.getElementById('progress');
    let current = 0;
    let currentImg = new Image();
    let startTime = 0;
    let currentPairNumber = 0;
    let displayAttempts = 0;
    let currentDisplayPhase = 0;
    let pairStartTime = 0;
    let currentImageType = '';
    let currentTimer = null;
    let isLastPair = false;
    
    // æ¯å¯¹å›¾ç‰‡çš„æœ€å¤§äº¤æ›¿æ¬¡æ•°
    const MAX_DISPLAYS = 30;
    
    // ç¤ºä¾‹å¼•å¯¼ç›¸å…³å˜é‡
    let currentTutorialPage = 1;
    const totalTutorialPages = 5;
    
    // ä¸Šä¼ ç›¸å…³å˜é‡
    const uploadErrorEl = document.getElementById('upload-error');
    const retryBtn = document.getElementById('retry-btn');
    
    async function preloadImages() {
      const categories = ["st"];
      const selectedPairs = [];
    
      // é€ç±»åŠ è½½
      async function loadCategory(folder) {
        const res = await fetch(`img_${folder}/image_list.json`);
        const files = await res.json();
    
        // æŒ‰ prefix åˆ†ç»„
        const groups = {};
        files.forEach(filename => {
          const prefix = filename.split('.')[0].split('_')[0];
          if (!groups[prefix]) groups[prefix] = [];
          groups[prefix].push(filename);
        });
        
        // ä»æ¯ç»„ä¸­æå–å›¾åƒå¯¹
        const pairs = [];
        for (const prefix in groups) {
          const group = groups[prefix];
          if (group.length < 2) continue;

          let baseImage = group.find(name => !name.includes('_'));
      
          if (!baseImage) {
            baseImage = group.reduce((shortest, current) => {
              return current.length < shortest.length ? current : shortest;
            }, group[0]);
          }
          
          const others = group.filter(f => f !== baseImage);
          const otherImage = others[Math.floor(Math.random() * others.length)];
          pairs.push([`img_${folder}/${otherImage}`, `img_${folder}/${baseImage}`]);
        }
    
        return getRandomItems(pairs, 10);
      }
    
      // ä»æ•°ç»„ä¸­éšæœºæŠ½å– count ä¸ªå…ƒç´ 
      function getRandomItems(arr, count) {
        const copy = [...arr];
        const result = [];
        for (let i = 0; i < count && copy.length > 0; i++) {
          const idx = Math.floor(Math.random() * copy.length);
          result.push(copy.splice(idx, 1)[0]);
        }
        return result;
      }
    
      // é€ä¸ªæ–‡ä»¶å¤¹åŠ è½½å›¾åƒå¯¹
      for (const c of categories) {
        const pairs = await loadCategory(c);
        selectedPairs.push(...pairs);
      }
    
      // ç”Ÿæˆæœ€ç»ˆçš„å›¾åƒå¯¹
      imagePairs = selectedPairs;

      // é¢„åŠ è½½ç¤ºä¾‹å›¾ç‰‡
      const tutorialImages = [
        'Calibration.jpeg',
        'example/example_1.jpg',
        'example/example_2.jpg',
        'example/example_3.jpg',
        'Slide1.jpeg'
      ];
      
      // é¢„åŠ è½½æ‰€æœ‰å›¾åƒå¹¶æ˜¾ç¤ºè¿›åº¦
      let loaded = 0;
      const total = imagePairs.length * 2 + tutorialImages.length;
      const preloadPromises = [];
    
      [...imagePairs.flat(), ...tutorialImages].forEach(src => {
        const img = new Image();
        const p = new Promise(resolve => {
          img.onload = () => {
            loaded++;
            progressEl.textContent = Math.round((loaded / total) * 100) + "%";
            resolve();
          };
          img.onerror = resolve;
          img.src = src;
          if (!tutorialImages.includes(src)) {
            allPreloadedImages.push(img);
          }
        });
        preloadPromises.push(p);
      });
      
      await Promise.all(preloadPromises);
      imagesReady = true;
      loadingEl.style.display = "none";
      
      statusEl.textContent = "Loading finished. Click anywhere to start the tutorial.";
      statusEl.style.cursor = "pointer";
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»åå¼€å§‹æ•™ç¨‹
      document.addEventListener('click', startTutorialOnClick);
    }

    // ç‚¹å‡»å±å¹•åå¼€å§‹æ•™ç¨‹
    function startTutorialOnClick(e) {
      if (imagesReady) {
        document.removeEventListener('click', startTutorialOnClick);
        initTutorial();
      }
    }

    // åˆå§‹åŒ–ç¤ºä¾‹å¼•å¯¼
    function initTutorial() {
      const tutorial = document.getElementById('tutorial');
      tutorial.style.display = 'block';
      statusEl.style.display = 'none';
      
      // åˆ›å»ºå¯¼èˆªç‚¹
      const dotsContainer = document.getElementById('dots');
      for (let i = 1; i <= totalTutorialPages; i++) {
        const dot = document.createElement('span');
        dot.className = 'dot';
        if (i === 1) dot.classList.add('active');
        dotsContainer.appendChild(dot);
      }
      
      // è®¾ç½®å¯¼èˆªæŒ‰é’®äº‹ä»¶
      document.getElementById('prev-btn').addEventListener('click', showPrevPage);
      document.getElementById('next-btn').addEventListener('click', function() {
        if (currentTutorialPage === totalTutorialPages) {
          startExperiment();
        } else {
          showNextPage();
        }
      });
      
      updateTutorialButtons();
    }

    // æ˜¾ç¤ºä¸Šä¸€é¡µ
    function showPrevPage() {
      if (currentTutorialPage > 1) {
        document.getElementById(`page-${currentTutorialPage}`).classList.remove('active');
        currentTutorialPage--;
        document.getElementById(`page-${currentTutorialPage}`).classList.add('active');
        updateTutorialButtons();
      }
    }

    // æ˜¾ç¤ºä¸‹ä¸€é¡µ
    function showNextPage() {
      if (currentTutorialPage < totalTutorialPages) {
        document.getElementById(`page-${currentTutorialPage}`).classList.remove('active');
        currentTutorialPage++;
        document.getElementById(`page-${currentTutorialPage}`).classList.add('active');
        updateTutorialButtons();
      }
    }
  
    // æ›´æ–°æ•™ç¨‹æŒ‰é’®çŠ¶æ€
    function updateTutorialButtons() {
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      
      prevBtn.disabled = currentTutorialPage === 1;
      
      if (currentTutorialPage === totalTutorialPages) {
        nextBtn.textContent = 'Start the experiment';
      } else {
        nextBtn.textContent = 'Next';
      }
      
      const dots = document.querySelectorAll('.dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index + 1 === currentTutorialPage);
      });
    }

    // å¼€å§‹æ­£å¼å®éªŒ
    function startExperiment() {
      document.getElementById('tutorial').style.display = 'none';
      document.getElementById('experiment').style.display = 'block';
      nextImage();
    }

    // æ˜¾ç¤ºä¸‹ä¸€ç»„å›¾ç‰‡
    function nextImage() {
      // æ¸…é™¤ä»»ä½•ç°æœ‰çš„å®šæ—¶å™¨
      if (currentTimer) {
        clearTimeout(currentTimer);
        currentTimer = null;
      }
      
      if (current >= imagePairs.length) {
        // æ‰€æœ‰å›¾ç‰‡å¯¹å¤„ç†å®Œæ¯•ï¼Œæ£€æŸ¥ä¸Šä¼ çŠ¶æ€
        checkAllUploads();
        return;
      }
    
      displayAttempts = 0;
      currentPairNumber = current + 1;
      currentDisplayPhase = 0;
      pairStartTime = performance.now();
      
      isLastPair = (current === imagePairs.length - 1);
      
      const [imgA, imgB] = imagePairs[current];
      console.log(`----- å¼€å§‹å¤„ç†ç¬¬ ${currentPairNumber} å¯¹å›¾ç‰‡ -----`);
      console.log(`å›¾ç‰‡A: ${imgA}`);
      console.log(`å›¾ç‰‡B: ${imgB}`);
      console.log('-------------------------');

      // æ˜¾ç¤ºæ ¡å‡†å›¾ç‰‡
      showCalibration();
    }
    
    // æ˜¾ç¤ºæ ¡å‡†å›¾ç‰‡
    function showCalibration() {
      const calibrationImg = new Image();
      calibrationImg.src = 'Calibration.jpeg';
      calibrationImg.onload = () => {
        canvas.width = 960;
        canvas.height = 720;
        ctx.drawImage(calibrationImg, 0, 0, 960, 720);
        msg.innerText = `pair${currentPairNumber} calibration`;
        
        // æ ¡å‡†500msåæ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 1;
          showFirstImage();
        }, 500);
      };
      
      calibrationImg.onerror = () => {
        console.error("Calibration image failed to load. Skipping...");
        // ç›´æ¥åŠ è½½ç¬¬ä¸€å¼ å›¾ç‰‡
        currentDisplayPhase = 1;
        showFirstImage();
      };
    }
    
    // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
    function showFirstImage() {
      const [imgA, imgB] = imagePairs[current];
      currentImg = new Image();
    
      currentImg.onload = () => {
        ctx.drawImage(currentImg, 0, 0, 960, 720);
        msg.innerText = `pair${currentPairNumber}-1 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        
        currentImageType = 'first';
        canvas.onclick = recordClick;
        
        // ç¬¬ä¸€å¼ å›¾å±•ç¤º500msç„¶åæ˜¾ç¤ºç°è‰²èƒŒæ™¯
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 2;
          showGrayScreen();
        }, 500);
      };
    
      currentImg.src = imgA;
    }
    
    // æ˜¾ç¤ºç°è‰²èƒŒæ™¯
    function showGrayScreen() {
      canvas.onclick = recordClick;
      ctx.fillStyle = "#d3d3d3";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      if (currentDisplayPhase === 2) {
        msg.innerText = `pair${currentPairNumber}-gray between 1 and 2 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        // é—´éš”ç°å±å±•ç¤º100msåæ˜¾ç¤ºç¬¬äºŒå¼ å›¾ç‰‡
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 3;
          showSecondImage();
        }, 100);
      } else if (currentDisplayPhase === 4) {
        msg.innerText = `pair${currentPairNumber}-gray between 2 and 1 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        // é—´éš”ç°å±å±•ç¤º100msåæ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
        currentTimer = setTimeout(() => {
          displayAttempts++;
          if (displayAttempts >= MAX_DISPLAYS) {
            // è¾¾åˆ°æœ€å¤§å±•ç¤ºæ¬¡æ•°ï¼Œå¤„ç†æœªç‚¹å‡»æƒ…å†µ
            handleNoClick();
            return;
          }
          
          currentDisplayPhase = 1;
          showFirstImage();
        }, 100);
      }
    }
    
    // æ˜¾ç¤ºç¬¬äºŒå¼ å›¾ç‰‡
    function showSecondImage() {
      const [, imgB] = imagePairs[current];
      const secondImg = new Image();
    
      secondImg.onload = () => {
        ctx.drawImage(secondImg, 0, 0, 960, 720);
        msg.innerText = `pair${currentPairNumber}-2 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        
        currentImageType = 'second';
        canvas.onclick = recordClick;
        
        // ç¬¬äºŒå¼ å›¾å±•ç¤º500msåæ˜¾ç¤ºç°è‰²èƒŒæ™¯
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 4;
          showGrayScreen();
        }, 500);
      };
    
      secondImg.src = imgB;
    }
    
    // å¸¦é‡è¯•æœºåˆ¶çš„ä¸Šä¼ å‡½æ•°
    function uploadData(payload) {
      payload.retryCount = payload.retryCount || 0; // åˆå§‹åŒ–é‡è¯•è®¡æ•°
      
      fetch("https://script.google.com/macros/s/AKfycby88M0KVbC5OeLttT0KofbQBNNgrsHEcRRUHeauhzZedR_BmbquifV6aUM-sM3GuhDs/exec", {
        method: "POST",
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) throw new Error("Upload failed");
        console.log(`Data uploaded successfully for pair ${payload.pairIndex}`);
      })
      .catch(error => {
        console.error(`Upload failed for pair ${payload.pairIndex}:`, error);
        payload.retryCount++;
        
        // æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
        if (payload.retryCount < MAX_RETRIES) {
          const delay = 2000 * Math.pow(2, payload.retryCount); // 2s, 4s, 8s
          console.log(`Retrying upload in ${delay/1000} seconds...`);
          setTimeout(() => uploadData(payload), delay);
        } else {
          console.error(`Permanent failure for pair ${payload.pairIndex}`);
          failedPayloads.push(payload); // è®°å½•æ°¸ä¹…å¤±è´¥çš„è¯·æ±‚
        }
      });
    }
    
    // å¤„ç†æœªç‚¹å‡»æƒ…å†µ
    function handleNoClick() {
      console.log(`Pair ${currentPairNumber} reached ${MAX_DISPLAYS} displays without click, proceeding...`);
      
      const payload = {
        imageData: 'no click',
        fileName: 'no click',
        userId,
        experimentId: current + 1,
        pairIndex: current + 1,
        timestamp: new Date().toLocaleString(),
        clickedX: 0,
        clickedY: 0,
        timeMs: Math.round(performance.now() - pairStartTime),
        imageA: imagePairs[current][0],
        imageB: imagePairs[current][1],
        attempts: displayAttempts,
        imageType: "third",
        referrer: participantInfo.referrer,
        queryParams: participantInfo.queryParams
      };

      // éé˜»å¡ä¸Šä¼ ï¼Œä¸ç­‰å¾…ç»“æœ
      uploadData(payload);
      
      // ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªPairï¼Œä¸ç­‰å¾…ä¸Šä¼ ç»“æœ
      handlePostUpload();
    }
    
    // è®°å½•ç‚¹å‡»äº‹ä»¶
    function recordClick(e) {
      // æ¸…é™¤å½“å‰çš„å®šæ—¶å™¨
      if (currentTimer) {
        clearTimeout(currentTimer);
        currentTimer = null;
      }
      
      const rect = canvas.getBoundingClientRect();
      const x = Math.round(e.clientX - rect.left);
      const y = Math.round(e.clientY - rect.top);
      const elapsed = Math.round(performance.now() - pairStartTime);
      
      // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»åœ¨ç°è‰²èƒŒæ™¯ä¸Š
      const isGrayBackground = currentDisplayPhase === 2 || currentDisplayPhase === 4;
      
      // å¦‚æœç‚¹å‡»åœ¨ç°è‰²èƒŒæ™¯ä¸Šï¼Œä¸ç»˜åˆ¶çº¢ç‚¹
      if (!isGrayBackground) {
        // ç»˜åˆ¶çº¢ç‚¹ï¼ˆä»…åœ¨å›¾ç‰‡ä¸Šç‚¹å‡»æ—¶ç»˜åˆ¶ï¼‰
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
      }

      // ç”Ÿæˆæ–‡ä»¶åå’Œæ—¶é—´æˆ³
      const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
      const pairIndex = current + 1;
      const fileName = `${userId}_pair${pairIndex}_${timestamp}_${currentImageType}.png`;

      // ç»„è£…æ•°æ®
      const payload = {
        imageData: isGrayBackground ? null : canvas.toDataURL("image/png"),
        fileName: isGrayBackground ? null : fileName,
        userId,
        experimentId: pairIndex,
        pairIndex,
        timestamp: new Date().toLocaleString(),
        clickedX: x,
        clickedY: y,
        timeMs: elapsed,
        imageA: imagePairs[current][0],
        imageB: imagePairs[current][1],
        attempts: displayAttempts + 1,
        imageType: currentImageType,
        referrer: participantInfo.referrer,
        queryParams: participantInfo.queryParams,
        clickedOnGray: isGrayBackground
      };

      // æ§åˆ¶å°æ‰“å°
      console.log("-------------------------");
      console.log("ç‚¹å‡»äº‹ä»¶è®°å½•", {
        å®éªŒç¼–å·: pairIndex,
        å›¾ç‰‡ç±»å‹: currentImageType,
        ç‚¹å‡»åæ ‡: `X: ${x}, Y: ${y}`,
        ååº”æ—¶é—´: `${elapsed} ms`,
        å±•ç¤ºæ¬¡æ•°: payload.attempts,
        å›¾ç‰‡å¯¹: `${payload.imageA} vs ${payload.imageB}`,
        æ˜¯å¦ç‚¹å‡»ç°è‰²èƒŒæ™¯: isGrayBackground
      });
      console.log("-------------------------");

      // éé˜»å¡ä¸Šä¼ ï¼Œä¸ç­‰å¾…ç»“æœ
      uploadData(payload);
      
      // ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªPairï¼Œä¸ç­‰å¾…ä¸Šä¼ ç»“æœ
      handlePostUpload();
    }
    
    // å¤„ç†ä¸Šä¼ åçš„æ­¥éª¤
    function handlePostUpload() {
      canvas.onclick = null;
      current++;
      
      // æ— è®ºä¸Šä¼ æ˜¯å¦æˆåŠŸï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªPairï¼ˆæœ€åä¸€ä¸ªPairé™¤å¤–ï¼‰
      if (current < imagePairs.length) {
        setTimeout(nextImage, 500);
      } else {
        // æ‰€æœ‰å›¾ç‰‡å¯¹å¤„ç†å®Œæ¯•ï¼Œæ£€æŸ¥ä¸Šä¼ çŠ¶æ€
        checkAllUploads();
      }
    }
    
    // æ£€æŸ¥æ‰€æœ‰ä¸Šä¼ çŠ¶æ€
    function checkAllUploads() {
      // æ˜¾ç¤ºç­‰å¾…ä¸Šä¼ çŠ¶æ€
      document.getElementById('experiment').style.display = 'none';
      document.getElementById('uploading').style.display = 'block';
      
      // å»¶è¿Ÿæ£€æŸ¥ï¼Œç»™ä¸Šä¼ è¯·æ±‚ä¸€äº›æ—¶é—´
      setTimeout(() => {
        document.getElementById('uploading').style.display = 'none';
        
        if (failedPayloads.length > 0) {
          showUploadFailureScreen();
        } else {
          showSuccessScreenAndRedirect();
        }
      }, 3000); // ç­‰å¾…3ç§’ï¼Œè®©ä¸Šä¼ è¯·æ±‚æœ‰æœºä¼šå®Œæˆ
    }
    
    // æ˜¾ç¤ºä¸Šä¼ å¤±è´¥ç•Œé¢
    function showUploadFailureScreen() {
      const uploadError = document.getElementById('upload-error');
      uploadError.style.display = 'block';
      
      // é‡è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šé‡æ–°ä¸Šä¼ æ‰€æœ‰å¤±è´¥çš„è¯·æ±‚
      document.getElementById('retry-btn').addEventListener('click', () => {
        uploadError.style.display = 'none';
        document.getElementById('uploading').style.display = 'block';
        
        // å¤åˆ¶å¤±è´¥åˆ—è¡¨å¹¶æ¸…ç©ºåŸåˆ—è¡¨
        const retries = [...failedPayloads];
        failedPayloads.length = 0;
        
        // é‡æ–°ä¸Šä¼ æ‰€æœ‰å¤±è´¥çš„è¯·æ±‚
        retries.forEach(payload => {
          payload.retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
          uploadData(payload);
        });
        
        // å†æ¬¡æ£€æŸ¥ä¸Šä¼ çŠ¶æ€
        setTimeout(() => {
          document.getElementById('uploading').style.display = 'none';
          if (failedPayloads.length > 0) {
            showUploadFailureScreen();
          } else {
            showSuccessScreenAndRedirect();
          }
        }, 3000);
      });
    }
    
    // æ˜¾ç¤ºæˆåŠŸç•Œé¢å¹¶è·³è½¬
    function showSuccessScreenAndRedirect() {
      const endScreen = document.getElementById('end-screen');
      endScreen.style.display = 'block';
      
      setTimeout(() => {
        window.location.href = "https://app.prolific.com/submissions/complete?cc=C1OH8WG7";
      }, 3000);
    }
  </script>
</body>
</html>
