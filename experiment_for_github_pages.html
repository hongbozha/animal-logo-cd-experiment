<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Start experiment</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
    }
    canvas {
      border: 2px solid #333;
      margin-top: 20px;
      cursor: crosshair;
    }
    #loading, #msg, #end-screen {
      max-width: 4000px;
      margin: 0 auto;
    }
    #loading {
      font-size: 20px;
      color: #555;
      margin-top: 40px;
    }
    #msg {
      font-size: 20px;
      color: #333;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #end-screen {
      color: green;
      font-size: 30px;
      margin-top: 30px;
    }
    /* æ–°å¢ç¤ºä¾‹å¼•å¯¼æ ·å¼ */
    #tutorial {
      display: none;
      max-width: 4000px;
      margin: 0 auto;
    }
    .tutorial-page {
      display: none;
    }
    .tutorial-page.active {
      display: block;
    }
    .tutorial-image {
      width: 1200px; /* å›ºå®šå®½åº¦ */
      border: 1px solid #ddd;
      margin: 0 auto; /* å›¾ç‰‡æ°´å¹³å±…ä¸­ */
      display: block; /* ç¡®ä¿ margin ç”Ÿæ•ˆ */
    }
    .tutorial-text {
      font-size: 20px;
      margin-bottom: 30px;
    }
    #tutorial-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .nav-button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dot {
      height: 15px;
      width: 15px;
      margin: 0 2px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.6s ease;
    }
    .dot.active {
      background-color: #4CAF50;
    }
  </style>
</head>
<body>
  <h1>Can you spot the change? Click it!</h1>
  <p id="status-msg" style="font-size:28px;">Please wait for the resources to be loaded</p>
  <div id="loading">ğŸ”„ Loading: <span id="progress">0%</span></div>

  <!-- æ–°å¢ç¤ºä¾‹å¼•å¯¼å®¹å™¨ -->
  <div id="tutorial">
    <!-- ç¤ºä¾‹é¡µé¢1 -->
    <div class="tutorial-page active" id="page-1">
      <img class="tutorial-image" src="Calibration.jpeg" alt="å®éªŒæµç¨‹ä»‹ç»">
      <div class="tutorial-text">Welcome! Before we begin the main task, weâ€™d like to provide a brief example to help you understand what to expect.<br>Please follow the on-screen instructions at your own pace.</div>
    </div>
    
    <!-- ç¤ºä¾‹é¡µé¢2 -->
    <div class="tutorial-page" id="page-2">
      <img class="tutorial-image" src="example/example_1.jpg" alt="å®éªŒæµç¨‹">
      <div class="tutorial-text">This is the first image in the example pair. Something in the image will change.<br>Please pay attention to the details. Click Next to continue.</div>
    </div>
    
    <!-- ç¤ºä¾‹é¡µé¢3 -->
    <div class="tutorial-page" id="page-3">
      <img class="tutorial-image" src="example/example_2.jpg" alt="ç¤ºä¾‹1">
      <div class="tutorial-text">This is the second image in the example pair. Something in the image has changed.<br>Try to spot the change compared to the previous image. Click Next to continue.</div>
    </div>
    
    <!-- ç¤ºä¾‹é¡µé¢4 -->
    <div class="tutorial-page" id="page-4">
      <img class="tutorial-image" src="example/example_3.jpg" alt="ç¤ºä¾‹2">
      <div class="tutorial-text">The highlighted area below shows where the change occurred.<br>In the main task, you will be asked to click on the changed area in the second image of each pair. Click Next to continue.</div>
    </div>
    
    <!-- ç¤ºä¾‹é¡µé¢5 -->
    <div class="tutorial-page" id="page-5">
      <img class="tutorial-image" src="Slide1.jpeg" alt="ç¤ºä¾‹3">
      <div class="tutorial-text">In the actual task, two images will be shown one after another in each trial. Your task is to click on the area that has changed in the second image.<br>Please try to respond as quickly and accurately as you can. Start the experiment when you are ready.</div>
    </div>
    
    <!-- å¯¼èˆªæŒ‰é’® -->
    <div id="tutorial-nav">
      <button class="nav-button" id="prev-btn" disabled>Previous</button>
      <div id="dots"></div>
      <button class="nav-button" id="next-btn">Next</button>
    </div>
  </div>
  
  <div id="experiment" style="display:none;">
    <canvas id="canvas" width="600"></canvas>
    <p id="msg">Preparing ...</p>
  </div>

  <div id="end-screen" style="display:none;">
    âœ… Experiment completed. Thanks for your participation! Redirecting to Prolific...
  </div>

  <script>
    // è·å– URL å‚æ•°
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search.slice(1);
      const pairs = queryString.split("&");
      for (const pair of pairs) {
        const [key, value] = pair.split("=");
        if (key) {
          params[decodeURIComponent(key)] = decodeURIComponent(value || "");
        }
      }
      return params;
    }
    
    // è·å–æ‰€æœ‰ URL å‚æ•°ï¼ˆåŒ…æ‹¬ Prolific å‚æ•°å’Œå…¶ä»–ï¼‰
    const queryParams = getQueryParams();
    const referrer = document.referrer || "direct";
    
    // è‡ªåŠ¨è®°å½•æ‰€æœ‰æŸ¥è¯¢å‚æ•°ï¼ˆä¸åªæ˜¯ Prolific çš„ç‰¹å®šå‚æ•°ï¼‰
    const participantInfo = {
      referrer: referrer,
      queryParams: JSON.stringify(queryParams) // æŠŠæ•´ä¸ª queryParams å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
    };
    
    console.log(participantInfo);  // å¯æŸ¥çœ‹æå–çš„æ‰€æœ‰å‚æ•°
    
    const userId = "user_" + Math.random().toString(36).substr(2, 8);
    let imagePairs = [];
    let allPreloadedImages = [];
    let imagesReady = false;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const msg = document.getElementById('msg');
    const endScreen = document.getElementById('end-screen');
    const loadingEl = document.getElementById('loading');
    const statusEl = document.getElementById('status-msg');
    const progressEl = document.getElementById('progress');
    let current = 0;
    let currentImg = new Image();
    let startTime = 0;

    // ç¤ºä¾‹å¼•å¯¼ç›¸å…³å˜é‡
    let currentTutorialPage = 1;
    const totalTutorialPages = 5;
    
    async function preloadImages() {
      // const categories = ["ec", "sm", "st"];
      const categories = ["st"];
      const selectedPairs = [];
    
      // é€ç±»åŠ è½½
      async function loadCategory(folder) {
        const res = await fetch(`img_${folder}/image_list.json`);
        const files = await res.json();
    
        // æŒ‰ prefix åˆ†ç»„ï¼ˆä¾‹å¦‚ a1, a2...ï¼‰
        const groups = {};
        files.forEach(filename => {
          const prefix = filename.split('.')[0].split('_')[0];
          if (!groups[prefix]) groups[prefix] = [];
          groups[prefix].push(filename);
        });
        // âœ… æ‰“å°æ¯ç»„çš„å‰ç¼€å’Œå†…å®¹
        console.log(`===== ${folder} æ–‡ä»¶å¤¹ä¸­çš„åˆ†ç»„ç»“æœ =====`);
        for (const prefix in groups) {
          console.log(`ç»„å‰ç¼€ï¼š${prefix}`);
          console.log(`åŒ…å«æ–‡ä»¶ï¼š`, groups[prefix]);
        }
        // ä»æ¯ç»„ä¸­æå–å›¾åƒå¯¹
        const pairs = [];
        for (const prefix in groups) {
          const group = groups[prefix];
          if (group.length < 2) continue;

          // âœ… ä¼˜å…ˆé€‰å–ä¸å«ä¸‹åˆ’çº¿çš„æ–‡ä»¶ä½œä¸º baseImage
          let baseImage = group.find(name => !name.includes('_'));
      
          // å¦‚æœæ²¡æœ‰æ— ä¸‹åˆ’çº¿çš„ï¼Œé€‰åå­—æœ€çŸ­çš„ä½œä¸ºå…œåº•æ–¹æ¡ˆ
          if (!baseImage) {
            baseImage = group.reduce((shortest, current) => {
              return current.length < shortest.length ? current : shortest;
            }, group[0]);
          }
          
          const others = group.filter(f => f !== baseImage);
          const otherImage = others[Math.floor(Math.random() * others.length)];
          pairs.push([`img_${folder}/${otherImage}`, `img_${folder}/${baseImage}`]);
        }
    
        // ä»è¯¥ç±»ä¸­éšæœºé€‰å‡ºNç»„
        return getRandomItems(pairs, 10);
      }
    
      // ä»æ•°ç»„ä¸­éšæœºæŠ½å– count ä¸ªå…ƒç´ 
      function getRandomItems(arr, count) {
        const copy = [...arr];
        const result = [];
        for (let i = 0; i < count && copy.length > 0; i++) {
          const idx = Math.floor(Math.random() * copy.length);
          result.push(copy.splice(idx, 1)[0]);
        }
        return result;
      }
    
      // é€ä¸ªæ–‡ä»¶å¤¹åŠ è½½å›¾åƒå¯¹
      for (const c of categories) {
        const pairs = await loadCategory(c);
        selectedPairs.push(...pairs);
      }
    
      // ç”Ÿæˆæœ€ç»ˆçš„å›¾åƒå¯¹
      imagePairs = selectedPairs;

      // é¢„åŠ è½½ç¤ºä¾‹å›¾ç‰‡
      const tutorialImages = [
        'Calibration.jpeg',
        'example/example_1.jpg',
        'example/example_2.jpg',
        'example/example_3.jpg',
        'Slide1.jpeg'
      ];
      
      // é¢„åŠ è½½æ‰€æœ‰å›¾åƒå¹¶æ˜¾ç¤ºè¿›åº¦
      let loaded = 0;
      const total = imagePairs.length * 2; // æ¯å¯¹å›¾åƒåŒ…å«ä¸¤ä¸ªæ–‡ä»¶
      const preloadPromises = [];
    
      imagePairs.flat().forEach(src => {
        const img = new Image();
        const p = new Promise(resolve => {
          img.onload = () => {
            loaded++;
            progressEl.textContent = Math.round((loaded / (total+tutorialImages.length) ) * 100) + "%";
            resolve();
          };
          img.onerror = resolve;
          img.src = src;
          allPreloadedImages.push(img);
        });
        preloadPromises.push(p);
      });

      // é¢„åŠ è½½ç¤ºä¾‹å›¾ç‰‡çš„è¿›åº¦æ¡
      tutorialImages.forEach(src => {
        const img = new Image();
        const p = new Promise(resolve => {
          img.onload = () => {
            loaded++;
            progressEl.textContent = Math.round((loaded / (total + tutorialImages.length)) * 100) + "%";
            resolve();
          };
          img.onerror = resolve;
          img.src = src;
        });
        preloadPromises.push(p);
      });
      
      await Promise.all(preloadPromises);
      imagesReady = true;
      loadingEl.style.display = "none";
      
      // ä¿®æ”¹ï¼šåŠ è½½å®Œæˆåæ›´æ–°çŠ¶æ€æ¶ˆæ¯ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»å¼€å§‹
      statusEl.textContent = "Loading finished. Click anywhere to start the tutorial.";
      statusEl.style.cursor = "pointer";
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»åå¼€å§‹æ•™ç¨‹
      document.addEventListener('click', startTutorialOnClick);
    }

    // ç‚¹å‡»å±å¹•åå¼€å§‹æ•™ç¨‹
    function startTutorialOnClick(e) {
      if (imagesReady) {
        document.removeEventListener('click', startTutorialOnClick);
        initTutorial();
      }
    }

    // åˆå§‹åŒ–ç¤ºä¾‹å¼•å¯¼
    function initTutorial() {
      const tutorial = document.getElementById('tutorial');
      tutorial.style.display = 'block';
      statusEl.style.display = 'none'; // éšè—çŠ¶æ€æ¶ˆæ¯ï¼Œå¼€å§‹æ•™ç¨‹
      
      // åˆ›å»ºå¯¼èˆªç‚¹
      const dotsContainer = document.getElementById('dots');
      for (let i = 1; i <= totalTutorialPages; i++) {
        const dot = document.createElement('span');
        dot.className = 'dot';
        if (i === 1) dot.classList.add('active');
        dotsContainer.appendChild(dot);
      }
      
      // è®¾ç½®å¯¼èˆªæŒ‰é’®äº‹ä»¶
      document.getElementById('prev-btn').addEventListener('click', showPrevPage);
      
      // ä¿®å¤ï¼šåªç»‘å®šä¸€æ¬¡äº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
      document.getElementById('next-btn').addEventListener('click', function() {
        if (currentTutorialPage === totalTutorialPages) {
          startExperiment();
        } else {
          showNextPage();
        }
      });
      
      updateTutorialButtons(); // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    }

    // æ˜¾ç¤ºä¸Šä¸€é¡µ
    function showPrevPage() {
      if (currentTutorialPage > 1) {
        document.getElementById(`page-${currentTutorialPage}`).classList.remove('active');
        currentTutorialPage--;
        document.getElementById(`page-${currentTutorialPage}`).classList.add('active');
        updateTutorialButtons();
      }
    }

    // æ˜¾ç¤ºä¸‹ä¸€é¡µ
    function showNextPage() {
      console.log(`å°è¯•æ˜¾ç¤ºä¸‹ä¸€é¡µï¼šå½“å‰é¡µ=${currentTutorialPage}, æ€»é¡µæ•°=${totalTutorialPages}`);
      
      if (currentTutorialPage < totalTutorialPages) {
        const currentPage = document.getElementById(`page-${currentTutorialPage}`);
        if (currentPage) {
          currentPage.classList.remove('active');
        } else {
          console.error(`å½“å‰é¡µé¢ page-${currentTutorialPage} ä¸å­˜åœ¨`);
          return;
        }
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€é¡µ
        currentTutorialPage++;
        console.log(`æ›´æ–°åçš„å½“å‰é¡µç¼–å·ï¼š${currentTutorialPage}`);
        
        const nextPage = document.getElementById(`page-${currentTutorialPage}`);
        if (nextPage) {
          nextPage.classList.add('active');
          updateTutorialButtons();
        } else {
          console.error(`é¡µé¢ page-${currentTutorialPage} ä¸å­˜åœ¨`);
        }
      } else {
        console.error(`å½“å‰é¡µå·²è¶…è¿‡æ€»é¡µæ•°ï¼š${currentTutorialPage}`);
      }
    }
  
    // æ›´æ–°æ•™ç¨‹æŒ‰é’®çŠ¶æ€
    function updateTutorialButtons() {
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      
      prevBtn.disabled = currentTutorialPage === 1;
      
      // ä¿®å¤ï¼šåªæ›´æ–°æŒ‰é’®æ–‡æœ¬ï¼Œä¸é‡æ–°ç»‘å®šäº‹ä»¶
      if (currentTutorialPage === totalTutorialPages) {
        nextBtn.textContent = 'Start the experiment';
      } else {
        nextBtn.textContent = 'Next';
      }
      
      const dots = document.querySelectorAll('.dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index + 1 === currentTutorialPage);
      });
      
      console.log(`æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šå½“å‰é¡µ=${currentTutorialPage}, æŒ‰é’®æ–‡æœ¬=${nextBtn.textContent}`);
    }

    // å¼€å§‹æ­£å¼å®éªŒ
    function startExperiment() {
      document.getElementById('tutorial').style.display = 'none';
      document.getElementById('experiment').style.display = 'block';
      nextImage();
    }

    preloadImages();

    function nextImage() {
      if (current >= imagePairs.length) {
        document.getElementById('experiment').style.display = 'none';
        endScreen.style.display = 'block';
        setTimeout(() => {
          window.location.href = "https://app.prolific.com/submissions/complete?cc=C1OH8WG7";
        }, 1000);
        return;
      }
    
      // æ˜¾ç¤ºæ ¡å‡†å›¾ç‰‡
      const calibrationImg = new Image();
      calibrationImg.src = 'Calibration.jpeg';
      calibrationImg.onload = () => {
        const originalWidth = calibrationImg.width;
        const originalHeight = calibrationImg.height;
        const scale = 900 / originalHeight; // ç»Ÿä¸€é«˜åº¦900px
        const calibWidth = originalWidth * scale;
        const calibHeight = 900;
    
        canvas.width = calibWidth;
        canvas.height = calibHeight;
        ctx.drawImage(calibrationImg, 0, 0, calibWidth, calibHeight);
    
        setTimeout(() => {
          const [imgA, imgB] = imagePairs[current];
          const pairNumber = current + 1;
          currentImg = new Image();
    
          currentImg.onload = () => {
            const originalWidth = currentImg.width;
            const originalHeight = currentImg.height;
            const scale = 900 / originalHeight;
            const unifiedWidth = originalWidth * scale;
            const unifiedHeight = 900;
    
            canvas.width = unifiedWidth;
            canvas.height = unifiedHeight;
            ctx.drawImage(currentImg, 0, 0, unifiedWidth, unifiedHeight);
            msg.innerText = `pair${pairNumber}-1`;
    
            setTimeout(() => {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              msg.innerText = "Loading...";
              setTimeout(() => {
                const secondImg = new Image();
                secondImg.onload = () => {
                  ctx.drawImage(secondImg, 0, 0, unifiedWidth, unifiedHeight);
                  msg.innerText = `pair${pairNumber}-2`;
                  startTime = performance.now();
                  canvas.onclick = recordClick;
                };
                secondImg.src = imgB;
              }, 200);
            }, 1500);
          };
    
          currentImg.src = imgA;
        }, 500);
      };
    
      calibrationImg.onerror = () => {
        console.error("Calibration image failed to load. Skipping...");
        // ç›´æ¥åŠ è½½å®éªŒå›¾ç‰‡å¯¹
        loadExperimentImagePair();
      };
    }

    function recordClick(e) {      
      const rect = canvas.getBoundingClientRect();
      const x = Math.round(e.clientX - rect.left);
      const y = Math.round(e.clientY - rect.top);
      const elapsed = Math.round(performance.now() - startTime);

      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(x, y, 10, 0, Math.PI * 2);
      ctx.fill();

      const imageData = canvas.toDataURL("image/png");
      const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
      const pairIndex = current + 1;
      const fileName = `${userId}_pair${pairIndex}_${timestamp}.png`;

      const payload = {
        imageData,
        fileName,
        userId,
        experimentId: pairIndex,
        pairIndex,
        timestamp: new Date().toLocaleString(),
        clickedX: x,
        clickedY: y,
        timeMs: elapsed,
        imageA: imagePairs[current][0],
        imageB: imagePairs[current][1],
        // æ·»åŠ å‚ä¸è€…å…ƒä¿¡æ¯
        referrer: participantInfo.referrer,
        queryParams: participantInfo.queryParams
      };

      console.log("Sending payload:", payload);
      
      fetch("https://script.google.com/macros/s/AKfycby88M0KVbC5OeLttT0KofbQBNNgrsHEcRRUHeauhzZedR_BmbquifV6aUM-sM3GuhDs/exec", {
        method: "POST",
        body: JSON.stringify(payload)
      }).catch((err) => {
        console.warn("Uploading failed (silent)", err);
      });

      canvas.onclick = null;
      current++;
      setTimeout(nextImage, 500);
    }
  </script>
</body>
</html>
