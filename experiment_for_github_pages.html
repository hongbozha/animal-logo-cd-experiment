<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å›¾åƒå®éªŒ - ä¸Šä¼ åˆ° Google Drive</title>
</head>
<body>
  <h1>å®éªŒï¼šä¸Šä¼ æ ‡æ³¨å›¾åˆ° Driveï¼ˆä»…ä½œè€…å¯è§ï¼‰</h1>
  <p>æŒ‰ä¸‹ç©ºæ ¼é”®å¼€å§‹</p>

  <div id="experiment" style="display:none;">
    <canvas id="canvas" width="600"></canvas>
    <p id="msg">åŠ è½½ä¸­...</p>
  </div>

  <div id="end-screen" style="display:none; color:green;">
    âœ… å®éªŒç»“æŸï¼Œå›¾åƒå·²ä¸Šä¼  Google Driveï¼
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script>
  // âœ… Firebase åˆå§‹åŒ–
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();

  // ğŸš€ è‡ªåŠ¨ä» Firebase Storage è·å–å›¾ç‰‡
  let imagePairs = [
  [
    "https://images.pexels.com/photos/18790037/pexels-photo-18790037/free-photo-of-deer-looking-at-camera.jpeg?auto=compress&cs=tinysrgb&w=1200&lazy=load",
    "https://images.pexels.com/photos/4482677/pexels-photo-4482677.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
  ],
  [
    "https://images.pexels.com/photos/20787/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    "https://images.pexels.com/photos/1805164/pexels-photo-1805164.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
  ]
];

  async function fetchImagePairsFromFirebase() {
    const listRef = storage.ref().child("images"); // æ”¾åœ¨ Firebase /images æ–‡ä»¶å¤¹ä¸‹
    const result = await listRef.listAll();
    const urls = await Promise.all(result.items.map(item => item.getDownloadURL()));
    urls.sort(); // æŒ‰æ–‡ä»¶åæ’åºï¼ˆå¯é€‰ï¼‰

    for (let i = 0; i < urls.length - 1; i += 2) {
      imagePairs.push([urls[i], urls[i + 1]]);
    }
  }

  // ç­‰å¾…åŠ è½½å®Œæ¯•å†å¼€å§‹å®éªŒæµç¨‹
  document.addEventListener('keydown', async function(e) {
    if (e.code === 'Space') {
      document.querySelector('p').style.display = 'none';
      document.getElementById('experiment').style.display = 'block';

      await fetchImagePairsFromFirebase();
      nextImage(); // åŸæœ¬å¼€å§‹å®éªŒçš„å…¥å£
    }
  });
</script>
<script>
    
// ğŸš€ ä» Firebase åŠ è½½å›¾ç‰‡åˆ—è¡¨å¹¶ç”Ÿæˆ imagePairs
let imagePairs = [
  [
    "https://images.pexels.com/photos/18790037/pexels-photo-18790037/free-photo-of-deer-looking-at-camera.jpeg?auto=compress&cs=tinysrgb&w=1200&lazy=load",
    "https://images.pexels.com/photos/4482677/pexels-photo-4482677.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
  ],
  [
    "https://images.pexels.com/photos/20787/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    "https://images.pexels.com/photos/1805164/pexels-photo-1805164.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
  ]
];
const firebaseImages = [
  // è¿™äº›åœ°å€æ˜¯ Firebase Storage å…¬å¼€å›¾åƒé“¾æ¥ï¼Œ2n å¼ è‡ªåŠ¨ä¸¤ä¸¤æˆå¯¹
  "https://firebasestorage.googleapis.com/v0/b/your-app-id.appspot.com/o/image1.jpg?alt=media",
  "https://firebasestorage.googleapis.com/v0/b/your-app-id.appspot.com/o/image2.jpg?alt=media",
  "https://firebasestorage.googleapis.com/v0/b/your-app-id.appspot.com/o/image3.jpg?alt=media",
  "https://firebasestorage.googleapis.com/v0/b/your-app-id.appspot.com/o/image4.jpg?alt=media"
];

// ä¸¤ä¸¤æˆå¯¹
for (let i = 0; i < firebaseImages.length - 1; i += 2) {
  imagePairs.push([firebaseImages[i], firebaseImages[i + 1]]);
}


    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const msg = document.getElementById('msg');
    const endScreen = document.getElementById('end-screen');
    let current = 0;
    let currentImg = new Image();
    let startTime = 0;

    document.addEventListener('keydown', function(e) {
      if (e.code === 'Space') {
        document.querySelector('p').style.display = 'none';
        document.getElementById('experiment').style.display = 'block';
        nextImage();
      }
    });

    function nextImage() {
      if (current >= imagePairs.length) {
        document.getElementById('experiment').style.display = 'none';
        endScreen.style.display = 'block';
        return;
      }

      const [imgA, imgB] = imagePairs[current];
      currentImg = new Image();
      currentImg.crossOrigin = "anonymous";
      currentImg.onload = () => {
        canvas.width = currentImg.width;
        canvas.height = currentImg.height;
        ctx.drawImage(currentImg, 0, 0);
        msg.innerText = `ç¬¬ ${current + 1} å¯¹å›¾ - ç¬¬ä¸€å¼ `;

        setTimeout(() => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          msg.innerText = "åˆ‡æ¢ä¸­...";
          setTimeout(() => {
            currentImg = new Image();
            currentImg.crossOrigin = "anonymous";
            currentImg.onload = () => {
              ctx.drawImage(currentImg, 0, 0);
              msg.innerText = "ç‚¹å‡»ä½ çœ‹åˆ°å˜åŒ–çš„åŒºåŸŸ";
              startTime = performance.now();
              canvas.onclick = recordClick;
            };
            currentImg.src = imgB;
          }, 200);
        }, 1000);
      };
      currentImg.src = imgA;
    }

    function recordClick(e) {
      const rect = canvas.getBoundingClientRect();
      const x = Math.round(e.clientX - rect.left);
      const y = Math.round(e.clientY - rect.top);
      const elapsed = Math.round(performance.now() - startTime);

      // æ ‡è®°ç‚¹å‡»ä½ç½®
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(x, y, 10, 0, Math.PI * 2);
      ctx.fill();

      // ä¸Šä¼ å›¾åƒåˆ° Apps Script
      const imageData = canvas.toDataURL("image/png");
      fetch("https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec", {
        method: "POST",
        body: JSON.stringify({ imageData })
      }).then(() => {
        console.log("âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ");
      }).catch((err) => {
        console.error("âŒ ä¸Šä¼ å¤±è´¥", err);
        alert("ä¸Šä¼ å¤±è´¥");
      });

      canvas.onclick = null;
      current++;
      setTimeout(nextImage, 500);
    }
  </script>
</body>
</html>
