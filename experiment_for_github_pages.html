<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Start experiment</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
    }
    canvas {
      border: 2px solid #333;
      margin-top: 20px;
      cursor: crosshair;
    }
    #consent-container {
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 30px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    #consent-container h2 {
      text-align: center;
    }
    #consent-container label {
      display: block;
      margin-top: 10px;
    }
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 3000px;
      margin: 20px auto;
    }
    .button-group button {
      width: 1000px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }
    #confirm-btn {
      background-color: #4CAF50;
      color: white;
    }
    #decline-btn {
      background-color: #ff4444;
      color: white;
    }
    #loading, #msg, #end-screen, #uploading, #upload-error {
      max-width: 4000px;
      margin: 0 auto;
    }
    #loading {
      font-size: 20px;
      color: #555;
      margin-top: 40px;
    }
    #msg {
      font-size: 20px;
      color: #333;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #end-screen {
      color: green;
      font-size: 30px;
      margin-top: 30px;
    }
    #tutorial {
      display: none;
      max-width: 4000px;
      margin: 0 auto;
    }
    .tutorial-page {
      display: none;
    }
    .tutorial-page.active {
      display: block;
    }
    .tutorial-image_extra {
      width: 960px;
      border: 2px solid #333;
      margin: 0 auto;
      display: block;
    }
    .tutorial-image {
      width: 960px;
      border: 0px solid #ddd;
      margin: 0 auto;
      display: block;
    }
    .tutorial-text {
      font-size: 20px;
      margin-bottom: 30px;
    }
    #tutorial-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .nav-button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dot {
      height: 15px;
      width: 15px;
      margin: 0 2px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.6s ease;
    }
    .dot.active {
      background-color: #4CAF50;
    }
    #uploading {
      font-size: 24px;
      color: #333;
      margin-top: 30px;
      display: none;
    }
    #upload-error {
      font-size: 20px;
      color: red;
      margin-top: 20px;
      display: none;
    }
    #retry-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="consent-container">
    <h1>PARTICIPANT INFORMATION SHEET</h1>
  
    <p><strong>Study Title:</strong><br>
    Detecting Image Changes in Everyday Scenes</p>
  
    <p><strong>Investigator:</strong><br>
    Yuqing Xu & Dr Miaolei Jia</p>
  
    <p>This study aims to examine how individuals detect visual changes in realistic scenes, such as shopfronts or product displays. The study aims to explore how different visual elements influence attention and the speed at which changes are noticed.</p>
  
    <p>After providing your consent, you will be asked to complete a brief online task. You will view pairs of alternating images that depict everyday commercial environments. In each pair, a small change will occur, and you will be asked to click on the location where you observe the difference. The task consists of approximately 10 to 20 trials and takes around 1 to 4 minutes to complete in total.</p>
  
    <p>Your participation is completely voluntary. You can withdraw at any time, and for any reason, simply by closing your browser. However, we can only pay you if you complete the study.</p>
  
    <p>No identifiable data will be collected from you as part of this study. This means that once your responses have been submitted to the research team, it will not be possible to withdraw this data as your individual responses cannot be identified.</p>
  
    <p>Data will be securely stored on University of Warwick computers and will be processed only for the purpose of scientific analysis. Access to the data will be restricted to Yuqing Xu and Dr Miaolei Jia. Summaries may be presented at conferences and included in scientific publications. Data will be reviewed after a period of 10 years, in line with the University of Warwick data retention policy.</p>
  
    <p>Please refer to the University of Warwick Research Privacy Notice which is available here: 
      <a href="https://warwick.ac.uk/services/idc/dataprotection/privacynotices/researchprivacynotice" target="_blank">
        University of Warwick Research Privacy Notice
      </a>
      or by contacting the Legal and Compliance Team at GDPR@warwick.ac.uk.</p>
  
    <p>This study has been reviewed and given favourable opinion by the University of Warwick‚Äôs Humanities and Social Science Research Ethics Committee (HSSREC).</p>
  
    <p>If you require further information, please contact Yuqing Xu via <a href="mailto:Yuqing.Xu.1@wbs.ac.uk">Yuqing.Xu.1@wbs.ac.uk</a>.</p>
  
    <p><strong>Who should I contact if I wish to make a complaint?</strong><br>
      Any complaint should be addressed to the person below, who is a senior University of Warwick official entirely independent of this study:</p>
    <p>
      Head of Research Governance<br>
      Research & Impact Services<br>
      University House<br>
      University of Warwick<br>
      Coventry<br>
      CV4 8UW<br>
      Email: <a href="mailto:researchgovernance@warwick.ac.uk">researchgovernance@warwick.ac.uk</a><br>
      Tel: 024 765 75733
    </p>
  
    <p>If you wish to raise a complaint on how we have handled your personal data, you can contact our Data Protection Officer, Information and Data Director who will investigate the matter: <a href="mailto:DPO@warwick.ac.uk">DPO@warwick.ac.uk</a>.</p>
  
    <p>If you are not satisfied with our response or believe we are processing your personal data in a way that is not lawful you can complain to the Information Commissioner‚Äôs Office (ICO).</p>
  
    <p><strong>Thank you for taking the time to read this Participant Information Leaflet.</strong></p>
    <div class="button-group">
      <!-- Consent button -->
      <button id="confirm-btn">I have read the above and consent to take part in this study.</button>
      <!-- Decline button -->
      <button id="decline-btn">I do not wish to participate.</button>
    </div>
    <p class="warning">If you click this button, the study will exit and you will not be able to participate.</p>
  
  </div>
  
  <div id="main-content" style="display: none;">
    <h1>Can you spot the change? Click it!</h1>
    <p id="status-msg" style="font-size:28px;">Please wait for the resources to be loaded</p>
    <div id="loading">üîÑ Loading: <span id="progress">0%</span></div>
  
    <!-- Êñ∞Â¢ûÁ§∫‰æãÂºïÂØºÂÆπÂô® -->
    <div id="tutorial">
      <!-- Á§∫‰æãÈ°µÈù¢1 -->
      <div class="tutorial-page active" id="page-1">
        <img class="tutorial-image_extra" src="Calibration.jpeg" alt="ÂÆûÈ™åÊµÅÁ®ã‰ªãÁªç">
        <div class="tutorial-text">Welcome! Before we begin the main task, we‚Äôd like to provide a brief example to help you understand what to expect.<br>Please follow the on-screen instructions at your own pace.</div>
      </div>
      
      <!-- Á§∫‰æãÈ°µÈù¢2 -->
      <div class="tutorial-page" id="page-2">
        <img class="tutorial-image" src="example/example_1.jpg" alt="ÂÆûÈ™åÊµÅÁ®ã">
        <div class="tutorial-text">This is the first image in the example pair. Something in the image will change.<br>Please pay attention to the details. Click Next to continue.</div>
      </div>
      
      <!-- Á§∫‰æãÈ°µÈù¢3 -->
      <div class="tutorial-page" id="page-3">
        <img class="tutorial-image" src="example/example_2.jpg" alt="Á§∫‰æã1">
        <div class="tutorial-text">This is the second image in the example pair. Something in the image has changed.<br>Try to spot the change compared to the previous image. Click Next to continue.</div>
      </div>
      
      <!-- Á§∫‰æãÈ°µÈù¢4 -->
      <div class="tutorial-page" id="page-4">
        <img class="tutorial-image" src="example/example_3.jpg" alt="Á§∫‰æã2">
        <div class="tutorial-text">The highlighted area below shows where the change occurred.<br>In the main task, you will be asked to click on the changed area in the second image of each pair. Click Next to continue.</div>
      </div>
      
      <!-- Á§∫‰æãÈ°µÈù¢5 -->
      <div class="tutorial-page" id="page-5">
        <img class="tutorial-image" src="Slide1.jpeg" alt="Á§∫‰æã3">
        <div class="tutorial-text">In the task, two images alternate until you click. Please respond quickly.<br>If no click is made after 30 alternations, that trial won‚Äôt be recorded. Start when you are ready.</div>
      </div>
      
      <!-- ÂØºËà™ÊåâÈíÆ -->
      <div id="tutorial-nav">
        <button class="nav-button" id="prev-btn" disabled>Previous</button>
        <div id="dots"></div>
        <button class="nav-button" id="next-btn">Next</button>
      </div>
    </div>
    
    <div id="experiment" style="display:none;">
      <canvas id="canvas" width="600"></canvas>
      <p id="msg">Preparing ...</p>
    </div>
  
    <div id="end-screen" style="display:none;">
      ‚úÖ Experiment completed. Thanks for your participation! Redirecting to Prolific...
    </div>
    <div id="uploading">‚åõ Waiting for data upload...</div>
    <div id="upload-error">
      ‚ùå Data upload failed. Please check your internet connection and try again.
      <button id="retry-btn">Retry Upload</button>
    </div>
  </div>
  <script>
    // Ëé∑ÂèñÂÖçË¥£Â£∞ÊòéÂÆπÂô®
    const consentContainer = document.getElementById("consent-container");
    
    const confirmBtn = document.getElementById("confirm-btn");
    const declineBtn = document.getElementById("decline-btn");
    const mainContent = document.getElementById("main-content");
    let timeoutHandle = setTimeout(() => {
      if (!confirmClicked && !declineClicked) {
        window.location.href = "about:blank";
      }
    }, 5 * 60 * 1000); // 5ÂàÜÈíüÂÄíËÆ°Êó∂

    let confirmClicked = false;
    let declineClicked = false;

    // Êñ∞Â¢ûÂÖ®Â±ÄÂèòÈáèÔºöËÆ∞ÂΩïÊâÄÊúâÂ§±Ë¥•ÁöÑ‰∏ä‰º†ËØ∑Ê±Ç
    const failedPayloads = [];
    const MAX_RETRIES = 3; // ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞
    
    // ÂêåÊÑèÊåâÈíÆÈÄªËæë
    confirmBtn.addEventListener("click", () => {
      confirmClicked = true;
      clearTimeout(timeoutHandle);
      
      if (consentContainer) {
        consentContainer.style.display = "none";
      } else {
        console.error("Error: consentContainer not found");
      }
      
      mainContent.style.display = "block";
      preloadImages();
    });

    // ÊãíÁªùÊåâÈíÆÈÄªËæë
    declineBtn.addEventListener("click", () => {
      if (!declineClicked) {
        declineClicked = true;
        clearTimeout(timeoutHandle);
        if (confirm("Are you sure you want to decline participation? This will close the experiment.")) {
          if (consentContainer) {
            consentContainer.style.display = "none";
          }
          window.location.href = "about:blank";
        }
      }
    });

    // Ëé∑Âèñ URL ÂèÇÊï∞
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search.slice(1);
      const pairs = queryString.split("&");
      for (const pair of pairs) {
        const [key, value] = pair.split("=");
        if (key) {
          params[decodeURIComponent(key)] = decodeURIComponent(value || "");
        }
      }
      return params;
    }
    
    // Ëé∑ÂèñÊâÄÊúâ URL ÂèÇÊï∞
    const queryParams = getQueryParams();
    const referrer = document.referrer || "direct";
    
    // ËÆ∞ÂΩïÊâÄÊúâÊü•ËØ¢ÂèÇÊï∞
    const participantInfo = {
      referrer: referrer,
      queryParams: JSON.stringify(queryParams)
    };
    
    console.log(participantInfo);
    
    const userId = "user_" + Math.random().toString(36).substr(2, 8);
    let imagePairs = [];
    let allPreloadedImages = [];
    let imagesReady = false;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const msg = document.getElementById('msg');
    const endScreen = document.getElementById('end-screen');
    const loadingEl = document.getElementById('loading');
    const statusEl = document.getElementById('status-msg');
    const progressEl = document.getElementById('progress');
    let current = 0;
    let currentImg = new Image();
    let startTime = 0;
    let currentPairNumber = 0;
    let displayAttempts = 0;
    let currentDisplayPhase = 0;
    let pairStartTime = 0;
    let currentImageType = '';
    let currentTimer = null;
    let isLastPair = false;
    
    // ÊØèÂØπÂõæÁâáÁöÑÊúÄÂ§ß‰∫§ÊõøÊ¨°Êï∞
    const MAX_DISPLAYS = 30;
    
    // Á§∫‰æãÂºïÂØºÁõ∏ÂÖ≥ÂèòÈáè
    let currentTutorialPage = 1;
    const totalTutorialPages = 5;
    
    // ‰∏ä‰º†Áõ∏ÂÖ≥ÂèòÈáè
    const uploadErrorEl = document.getElementById('upload-error');
    const retryBtn = document.getElementById('retry-btn');
    
    async function preloadImages() {
      const categories = ["st"];
      const selectedPairs = [];
    
      // ÈÄêÁ±ªÂä†ËΩΩ
      async function loadCategory(folder) {
        const res = await fetch(`img_${folder}/image_list.json`);
        const files = await res.json();
    
        // Êåâ prefix ÂàÜÁªÑ
        const groups = {};
        files.forEach(filename => {
          const prefix = filename.split('.')[0].split('_')[0];
          if (!groups[prefix]) groups[prefix] = [];
          groups[prefix].push(filename);
        });
        
        // ‰ªéÊØèÁªÑ‰∏≠ÊèêÂèñÂõæÂÉèÂØπ
        const pairs = [];
        for (const prefix in groups) {
          const group = groups[prefix];
          if (group.length < 2) continue;

          let baseImage = group.find(name => !name.includes('_'));
      
          if (!baseImage) {
            baseImage = group.reduce((shortest, current) => {
              return current.length < shortest.length ? current : shortest;
            }, group[0]);
          }
          
          const others = group.filter(f => f !== baseImage);
          const otherImage = others[Math.floor(Math.random() * others.length)];
          pairs.push([`img_${folder}/${otherImage}`, `img_${folder}/${baseImage}`]);
        }
    
        return getRandomItems(pairs, 10);
      }
    
      // ‰ªéÊï∞ÁªÑ‰∏≠ÈöèÊú∫ÊäΩÂèñ count ‰∏™ÂÖÉÁ¥†
      function getRandomItems(arr, count) {
        const copy = [...arr];
        const result = [];
        for (let i = 0; i < count && copy.length > 0; i++) {
          const idx = Math.floor(Math.random() * copy.length);
          result.push(copy.splice(idx, 1)[0]);
        }
        return result;
      }
    
      // ÈÄê‰∏™Êñá‰ª∂Â§πÂä†ËΩΩÂõæÂÉèÂØπ
      for (const c of categories) {
        const pairs = await loadCategory(c);
        selectedPairs.push(...pairs);
      }
    
      // ÁîüÊàêÊúÄÁªàÁöÑÂõæÂÉèÂØπ
      imagePairs = selectedPairs;

      // È¢ÑÂä†ËΩΩÁ§∫‰æãÂõæÁâá
      const tutorialImages = [
        'Calibration.jpeg',
        'example/example_1.jpg',
        'example/example_2.jpg',
        'example/example_3.jpg',
        'Slide1.jpeg'
      ];
      
      // È¢ÑÂä†ËΩΩÊâÄÊúâÂõæÂÉèÂπ∂ÊòæÁ§∫ËøõÂ∫¶
      let loaded = 0;
      const total = imagePairs.length * 2 + tutorialImages.length;
      const preloadPromises = [];
    
      [...imagePairs.flat(), ...tutorialImages].forEach(src => {
        const img = new Image();
        const p = new Promise(resolve => {
          img.onload = () => {
            loaded++;
            progressEl.textContent = Math.round((loaded / total) * 100) + "%";
            resolve();
          };
          img.onerror = resolve;
          img.src = src;
          if (!tutorialImages.includes(src)) {
            allPreloadedImages.push(img);
          }
        });
        preloadPromises.push(p);
      });
      
      await Promise.all(preloadPromises);
      imagesReady = true;
      loadingEl.style.display = "none";
      
      statusEl.textContent = "Loading finished. Click anywhere to start the tutorial.";
      statusEl.style.cursor = "pointer";
      
      // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÁÇπÂáªÂêéÂºÄÂßãÊïôÁ®ã
      document.addEventListener('click', startTutorialOnClick);
    }

    // ÁÇπÂáªÂ±èÂπïÂêéÂºÄÂßãÊïôÁ®ã
    function startTutorialOnClick(e) {
      if (imagesReady) {
        document.removeEventListener('click', startTutorialOnClick);
        initTutorial();
      }
    }

    // ÂàùÂßãÂåñÁ§∫‰æãÂºïÂØº
    function initTutorial() {
      const tutorial = document.getElementById('tutorial');
      tutorial.style.display = 'block';
      statusEl.style.display = 'none';
      
      // ÂàõÂª∫ÂØºËà™ÁÇπ
      const dotsContainer = document.getElementById('dots');
      for (let i = 1; i <= totalTutorialPages; i++) {
        const dot = document.createElement('span');
        dot.className = 'dot';
        if (i === 1) dot.classList.add('active');
        dotsContainer.appendChild(dot);
      }
      
      // ËÆæÁΩÆÂØºËà™ÊåâÈíÆ‰∫ã‰ª∂
      document.getElementById('prev-btn').addEventListener('click', showPrevPage);
      document.getElementById('next-btn').addEventListener('click', function() {
        if (currentTutorialPage === totalTutorialPages) {
          startExperiment();
        } else {
          showNextPage();
        }
      });
      
      updateTutorialButtons();
    }

    // ÊòæÁ§∫‰∏ä‰∏ÄÈ°µ
    function showPrevPage() {
      if (currentTutorialPage > 1) {
        document.getElementById(`page-${currentTutorialPage}`).classList.remove('active');
        currentTutorialPage--;
        document.getElementById(`page-${currentTutorialPage}`).classList.add('active');
        updateTutorialButtons();
      }
    }

    // ÊòæÁ§∫‰∏ã‰∏ÄÈ°µ
    function showNextPage() {
      if (currentTutorialPage < totalTutorialPages) {
        document.getElementById(`page-${currentTutorialPage}`).classList.remove('active');
        currentTutorialPage++;
        document.getElementById(`page-${currentTutorialPage}`).classList.add('active');
        updateTutorialButtons();
      }
    }
  
    // Êõ¥Êñ∞ÊïôÁ®ãÊåâÈíÆÁä∂ÊÄÅ
    function updateTutorialButtons() {
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      
      prevBtn.disabled = currentTutorialPage === 1;
      
      if (currentTutorialPage === totalTutorialPages) {
        nextBtn.textContent = 'Start the experiment';
      } else {
        nextBtn.textContent = 'Next';
      }
      
      const dots = document.querySelectorAll('.dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index + 1 === currentTutorialPage);
      });
    }

    // ÂºÄÂßãÊ≠£ÂºèÂÆûÈ™å
    function startExperiment() {
      document.getElementById('tutorial').style.display = 'none';
      document.getElementById('experiment').style.display = 'block';
      nextImage();
    }

    // ÊòæÁ§∫‰∏ã‰∏ÄÁªÑÂõæÁâá
    function nextImage() {
      // Ê∏ÖÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑÂÆöÊó∂Âô®
      if (currentTimer) {
        clearTimeout(currentTimer);
        currentTimer = null;
      }
      
      if (current >= imagePairs.length) {
        // ÊâÄÊúâÂõæÁâáÂØπÂ§ÑÁêÜÂÆåÊØïÔºåÊ£ÄÊü•‰∏ä‰º†Áä∂ÊÄÅ
        checkAllUploads();
        return;
      }
    
      displayAttempts = 0;
      currentPairNumber = current + 1;
      currentDisplayPhase = 0;
      pairStartTime = performance.now();
      
      isLastPair = (current === imagePairs.length - 1);
      
      const [imgA, imgB] = imagePairs[current];
      console.log(`----- ÂºÄÂßãÂ§ÑÁêÜÁ¨¨ ${currentPairNumber} ÂØπÂõæÁâá -----`);
      console.log(`ÂõæÁâáA: ${imgA}`);
      console.log(`ÂõæÁâáB: ${imgB}`);
      console.log('-------------------------');

      // ÊòæÁ§∫Ê†°ÂáÜÂõæÁâá
      showCalibration();
    }
    
    // ÊòæÁ§∫Ê†°ÂáÜÂõæÁâá
    function showCalibration() {
      const calibrationImg = new Image();
      calibrationImg.src = 'Calibration.jpeg';
      calibrationImg.onload = () => {
        canvas.width = 960;
        canvas.height = 720;
        ctx.drawImage(calibrationImg, 0, 0, 960, 720);
        msg.innerText = `pair${currentPairNumber} calibration`;
        
        // Ê†°ÂáÜ500msÂêéÊòæÁ§∫Á¨¨‰∏ÄÂº†ÂõæÁâá
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 1;
          showFirstImage();
        }, 500);
      };
      
      calibrationImg.onerror = () => {
        console.error("Calibration image failed to load. Skipping...");
        // Áõ¥Êé•Âä†ËΩΩÁ¨¨‰∏ÄÂº†ÂõæÁâá
        currentDisplayPhase = 1;
        showFirstImage();
      };
    }
    
    // ÊòæÁ§∫Á¨¨‰∏ÄÂº†ÂõæÁâá
    function showFirstImage() {
      const [imgA, imgB] = imagePairs[current];
      currentImg = new Image();
    
      currentImg.onload = () => {
        ctx.drawImage(currentImg, 0, 0, 960, 720);
        msg.innerText = `pair${currentPairNumber}-1 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        
        currentImageType = 'first';
        canvas.onclick = recordClick;
        
        // Á¨¨‰∏ÄÂº†ÂõæÂ±ïÁ§∫500msÁÑ∂ÂêéÊòæÁ§∫ÁÅ∞Ëâ≤ËÉåÊôØ
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 2;
          showGrayScreen();
        }, 500);
      };
    
      currentImg.src = imgA;
    }
    
    // ÊòæÁ§∫ÁÅ∞Ëâ≤ËÉåÊôØ
    function showGrayScreen() {
      canvas.onclick = recordClick;
      ctx.fillStyle = "#d3d3d3";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      if (currentDisplayPhase === 2) {
        msg.innerText = `pair${currentPairNumber}-gray between 1 and 2 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        // Èó¥ÈöîÁÅ∞Â±èÂ±ïÁ§∫100msÂêéÊòæÁ§∫Á¨¨‰∫åÂº†ÂõæÁâá
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 3;
          showSecondImage();
        }, 100);
      } else if (currentDisplayPhase === 4) {
        msg.innerText = `pair${currentPairNumber}-gray between 2 and 1 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        // Èó¥ÈöîÁÅ∞Â±èÂ±ïÁ§∫100msÂêéÊòæÁ§∫Á¨¨‰∏ÄÂº†ÂõæÁâá
        currentTimer = setTimeout(() => {
          displayAttempts++;
          if (displayAttempts >= MAX_DISPLAYS) {
            // ËææÂà∞ÊúÄÂ§ßÂ±ïÁ§∫Ê¨°Êï∞ÔºåÂ§ÑÁêÜÊú™ÁÇπÂáªÊÉÖÂÜµ
            handleNoClick();
            return;
          }
          
          currentDisplayPhase = 1;
          showFirstImage();
        }, 100);
      }
    }
    
    // ÊòæÁ§∫Á¨¨‰∫åÂº†ÂõæÁâá
    function showSecondImage() {
      const [, imgB] = imagePairs[current];
      const secondImg = new Image();
    
      secondImg.onload = () => {
        ctx.drawImage(secondImg, 0, 0, 960, 720);
        msg.innerText = `pair${currentPairNumber}-2 (display ${displayAttempts+1}/${MAX_DISPLAYS})`;
        
        currentImageType = 'second';
        canvas.onclick = recordClick;
        
        // Á¨¨‰∫åÂº†ÂõæÂ±ïÁ§∫500msÂêéÊòæÁ§∫ÁÅ∞Ëâ≤ËÉåÊôØ
        currentTimer = setTimeout(() => {
          currentDisplayPhase = 4;
          showGrayScreen();
        }, 500);
      };
    
      secondImg.src = imgB;
    }
    
    // Â∏¶ÈáçËØïÊú∫Âà∂ÁöÑ‰∏ä‰º†ÂáΩÊï∞
    function uploadData(payload) {
      payload.retryCount = payload.retryCount || 0; // ÂàùÂßãÂåñÈáçËØïËÆ°Êï∞
      
      fetch("https://script.google.com/macros/s/AKfycby88M0KVbC5OeLttT0KofbQBNNgrsHEcRRUHeauhzZedR_BmbquifV6aUM-sM3GuhDs/exec", {
        method: "POST",
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) throw new Error("Upload failed");
        console.log(`Data uploaded successfully for pair ${payload.pairIndex}`);
      })
      .catch(error => {
        console.error(`Upload failed for pair ${payload.pairIndex}:`, error);
        payload.retryCount++;
        
        // ÊåáÊï∞ÈÄÄÈÅøÈáçËØïÁ≠ñÁï•
        if (payload.retryCount < MAX_RETRIES) {
          const delay = 2000 * Math.pow(2, payload.retryCount); // 2s, 4s, 8s
          console.log(`Retrying upload in ${delay/1000} seconds...`);
          setTimeout(() => uploadData(payload), delay);
        } else {
          console.error(`Permanent failure for pair ${payload.pairIndex}`);
          failedPayloads.push(payload); // ËÆ∞ÂΩïÊ∞∏‰πÖÂ§±Ë¥•ÁöÑËØ∑Ê±Ç
        }
      });
    }
    
    // Â§ÑÁêÜÊú™ÁÇπÂáªÊÉÖÂÜµ
    function handleNoClick() {
      console.log(`Pair ${currentPairNumber} reached ${MAX_DISPLAYS} displays without click, proceeding...`);
      
      const payload = {
        imageData: 'no click',
        fileName: 'no click',
        userId,
        experimentId: current + 1,
        pairIndex: current + 1,
        timestamp: new Date().toLocaleString(),
        clickedX: 0,
        clickedY: 0,
        timeMs: Math.round(performance.now() - pairStartTime),
        imageA: imagePairs[current][0],
        imageB: imagePairs[current][1],
        attempts: displayAttempts,
        imageType: "third",
        referrer: participantInfo.referrer,
        queryParams: participantInfo.queryParams
      };

      // ÈùûÈòªÂ°û‰∏ä‰º†Ôºå‰∏çÁ≠âÂæÖÁªìÊûú
      uploadData(payload);
      
      // Áõ¥Êé•ËøõÂÖ•‰∏ã‰∏Ä‰∏™PairÔºå‰∏çÁ≠âÂæÖ‰∏ä‰º†ÁªìÊûú
      handlePostUpload();
    }
    
    // ËÆ∞ÂΩïÁÇπÂáª‰∫ã‰ª∂
    function recordClick(e) {
      // Ê∏ÖÈô§ÂΩìÂâçÁöÑÂÆöÊó∂Âô®
      if (currentTimer) {
        clearTimeout(currentTimer);
        currentTimer = null;
      }
      
      const rect = canvas.getBoundingClientRect();
      const x = Math.round(e.clientX - rect.left);
      const y = Math.round(e.clientY - rect.top);
      const elapsed = Math.round(performance.now() - pairStartTime);
      
      // Âà§Êñ≠ÊòØÂê¶ÁÇπÂáªÂú®ÁÅ∞Ëâ≤ËÉåÊôØ‰∏ä
      const isGrayBackground = currentDisplayPhase === 2 || currentDisplayPhase === 4;
      
      // Â¶ÇÊûúÁÇπÂáªÂú®ÁÅ∞Ëâ≤ËÉåÊôØ‰∏äÔºå‰∏çÁªòÂà∂Á∫¢ÁÇπ
      if (!isGrayBackground) {
        // ÁªòÂà∂Á∫¢ÁÇπÔºà‰ªÖÂú®ÂõæÁâá‰∏äÁÇπÂáªÊó∂ÁªòÂà∂Ôºâ
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
      }

      // ÁîüÊàêÊñá‰ª∂ÂêçÂíåÊó∂Èó¥Êà≥
      const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
      const pairIndex = current + 1;
      const fileName = `${userId}_pair${pairIndex}_${timestamp}_${currentImageType}.png`;

      // ÁªÑË£ÖÊï∞ÊçÆ
      const payload = {
        imageData: isGrayBackground ? null : canvas.toDataURL("image/png"),
        fileName: isGrayBackground ? null : fileName,
        userId,
        experimentId: pairIndex,
        pairIndex,
        timestamp: new Date().toLocaleString(),
        clickedX: x,
        clickedY: y,
        timeMs: elapsed,
        imageA: imagePairs[current][0],
        imageB: imagePairs[current][1],
        attempts: displayAttempts + 1,
        imageType: currentImageType,
        referrer: participantInfo.referrer,
        queryParams: participantInfo.queryParams,
        clickedOnGray: isGrayBackground
      };

      // ÊéßÂà∂Âè∞ÊâìÂç∞
      console.log("-------------------------");
      console.log("ÁÇπÂáª‰∫ã‰ª∂ËÆ∞ÂΩï", {
        ÂÆûÈ™åÁºñÂè∑: pairIndex,
        ÂõæÁâáÁ±ªÂûã: currentImageType,
        ÁÇπÂáªÂùêÊ†á: `X: ${x}, Y: ${y}`,
        ÂèçÂ∫îÊó∂Èó¥: `${elapsed} ms`,
        Â±ïÁ§∫Ê¨°Êï∞: payload.attempts,
        ÂõæÁâáÂØπ: `${payload.imageA} vs ${payload.imageB}`,
        ÊòØÂê¶ÁÇπÂáªÁÅ∞Ëâ≤ËÉåÊôØ: isGrayBackground
      });
      console.log("-------------------------");

      // ÈùûÈòªÂ°û‰∏ä‰º†Ôºå‰∏çÁ≠âÂæÖÁªìÊûú
      uploadData(payload);
      
      // Áõ¥Êé•ËøõÂÖ•‰∏ã‰∏Ä‰∏™PairÔºå‰∏çÁ≠âÂæÖ‰∏ä‰º†ÁªìÊûú
      handlePostUpload();
    }
    
    // Â§ÑÁêÜ‰∏ä‰º†ÂêéÁöÑÊ≠•È™§
    function handlePostUpload() {
      canvas.onclick = null;
      current++;
      
      // Êó†ËÆ∫‰∏ä‰º†ÊòØÂê¶ÊàêÂäüÔºåÁõ¥Êé•ËøõÂÖ•‰∏ã‰∏Ä‰∏™PairÔºàÊúÄÂêé‰∏Ä‰∏™PairÈô§Â§ñÔºâ
      if (current < imagePairs.length) {
        setTimeout(nextImage, 500);
      } else {
        // ÊâÄÊúâÂõæÁâáÂØπÂ§ÑÁêÜÂÆåÊØïÔºåÊ£ÄÊü•‰∏ä‰º†Áä∂ÊÄÅ
        checkAllUploads();
      }
    }
    
    // Ê£ÄÊü•ÊâÄÊúâ‰∏ä‰º†Áä∂ÊÄÅ
    function checkAllUploads() {
      // ÊòæÁ§∫Á≠âÂæÖ‰∏ä‰º†Áä∂ÊÄÅ
      document.getElementById('experiment').style.display = 'none';
      document.getElementById('uploading').style.display = 'block';
      
      // Âª∂ËøüÊ£ÄÊü•ÔºåÁªô‰∏ä‰º†ËØ∑Ê±Ç‰∏Ä‰∫õÊó∂Èó¥
      setTimeout(() => {
        document.getElementById('uploading').style.display = 'none';
        
        if (failedPayloads.length > 0) {
          showUploadFailureScreen();
        } else {
          showSuccessScreenAndRedirect();
        }
      }, 3000); // Á≠âÂæÖ3ÁßíÔºåËÆ©‰∏ä‰º†ËØ∑Ê±ÇÊúâÊú∫‰ºöÂÆåÊàê
    }
    
    // ÊòæÁ§∫‰∏ä‰º†Â§±Ë¥•ÁïåÈù¢
    function showUploadFailureScreen() {
      const uploadError = document.getElementById('upload-error');
      uploadError.style.display = 'block';
      
      // ÈáçËØïÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ÔºöÈáçÊñ∞‰∏ä‰º†ÊâÄÊúâÂ§±Ë¥•ÁöÑËØ∑Ê±Ç
      document.getElementById('retry-btn').addEventListener('click', () => {
        uploadError.style.display = 'none';
        document.getElementById('uploading').style.display = 'block';
        
        // Â§çÂà∂Â§±Ë¥•ÂàóË°®Âπ∂Ê∏ÖÁ©∫ÂéüÂàóË°®
        const retries = [...failedPayloads];
        failedPayloads.length = 0;
        
        // ÈáçÊñ∞‰∏ä‰º†ÊâÄÊúâÂ§±Ë¥•ÁöÑËØ∑Ê±Ç
        retries.forEach(payload => {
          payload.retryCount = 0; // ÈáçÁΩÆÈáçËØïËÆ°Êï∞
          uploadData(payload);
        });
        
        // ÂÜçÊ¨°Ê£ÄÊü•‰∏ä‰º†Áä∂ÊÄÅ
        setTimeout(() => {
          document.getElementById('uploading').style.display = 'none';
          if (failedPayloads.length > 0) {
            showUploadFailureScreen();
          } else {
            showSuccessScreenAndRedirect();
          }
        }, 3000);
      });
    }
    
    // ÊòæÁ§∫ÊàêÂäüÁïåÈù¢Âπ∂Ë∑≥ËΩ¨
    function showSuccessScreenAndRedirect() {
      const endScreen = document.getElementById('end-screen');
      endScreen.style.display = 'block';
      
      setTimeout(() => {
        window.location.href = "https://app.prolific.com/submissions/complete?cc=C1OH8WG7";
      }, 3000);
    }
  </script>
</body>
</html>
